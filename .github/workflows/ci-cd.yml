name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  DATABASE_URL: ${{ secrets.MONGODB_URI }}
  SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
  SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
  NOVA_API: ${{ secrets.NOVA_API }}
  WAYFORPAY_MERCHANT_ACCOUNT: ${{ secrets.WAYFORPAY_MERCHANT_ACCOUNT }}
  WAYFORPAY_SECRET_KEY: ${{ secrets.WAYFORPAY_SECRET_KEY }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
        uses: actions/checkout@v3

      - name: ‚éî –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: üì• –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
        run: npm install

      - name: üíÑ Prettier format
        run: npm run format
        
      - name: üî¨ –õ—ñ–Ω—Ç–∏–Ω–≥
        run: npm run lint

      - name: üíÖ Prettier check
        run: npm run check

      - name: üèó –ó–±—ñ—Ä–∫–∞ Next.js
        run: npm run build

      - name: üê≥ Docker Login (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        if: env.DOCKER_USER
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKER_USER }}" --password-stdin

      - name: üì¶ Docker Build & Push
        if: env.DOCKER_USER
        run: |
          IMAGE_NAME=${{ env.DOCKER_USER }}/paro-master

          echo "üßπ –ó—É–ø–∏–Ω–∫–∞ —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—è–∫—â–æ —î)"
          docker rm -f paro-master || true

          echo "üßº –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ–≥–æ –æ–±—Ä–∞–∑—É (—è–∫—â–æ —î)"
          docker rmi -f $IMAGE_NAME:latest || true

          echo "üî® –ó–±—ñ—Ä–∫–∞ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑—É"
          docker build -t $IMAGE_NAME:latest .

          echo "üè∑Ô∏è –¢–µ–≥—É–≤–∞–Ω–Ω—è –∫–æ–º—ñ—Ç–æ–º"
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:${{ github.sha }}

          echo "üöÄ –ü—É—à —É DockerHub"
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ github.sha }}

      - name: üê≥ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          IMAGE_NAME=${{ env.DOCKER_USER:-ivaros }}/paro-master

          echo "üåÄ –°—Ç–∞—Ä—Ç –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
          docker run -d --name paro-master \
            -p 3030:3000 \
            -e NODE_ENV=production \
            $IMAGE_NAME:latest \
            sh -c "next start -H 0.0.0.0 -p 3000"

          echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          sleep 10

          echo "üì° –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ"
          curl -I http://localhost:3030 || echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø"

          echo "üì¶ –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
          docker logs paroMaster

      - name: ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if: always() # <-- –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –±–∏–ª–¥ —É–ø–∞–ª
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI/CD: ${{ job.status }} –¥–ª—è paroMaster"
          body: |
            –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞: ${{ job.status }}
            –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          to: "ivan.roschin@86gmail.com"
          from: "CI/CD Bot <${{ secrets.SMTP_EMAIL }}>"

      - name: üì≤ Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ CI/CD –∑–∞–≤–µ—Ä—à–µ–Ω!
            üì¶ –û–±—Ä–∞–∑: ${{ github.sha }}
            üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
        uses: actions/checkout@v3

      - name: ‚éî –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: üì• –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
        run: npm install

      - name: üíÑ Prettier format
        run: npm run format
        
      - name: üî¨ –õ—ñ–Ω—Ç–∏–Ω–≥
        run: npm run lint

      - name: üíÖ Prettier check
        run: npm run check

      - name: üèó –ó–±—ñ—Ä–∫–∞ Next.js
        run: npm run build

      - name: üê≥ Docker Login
        if: ${{ env.DOCKER_USER }}
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ env.DOCKER_USER }}" --password-stdin

      - name: üì¶ Docker Build & Push
        if: ${{ env.DOCKER_USER }}
        run: |
          IMAGE_NAME=${{ env.DOCKER_USER }}/paro-master
          docker rm -f paro-master || true
          docker rmi -f $IMAGE_NAME:latest || true
          docker build -t $IMAGE_NAME:latest .
          docker tag $IMAGE_NAME:latest $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ github.sha }}

      - name: üê≥ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        run: |
          IMAGE_NAME=${{ env.DOCKER_USER:-ivaros }}/paro-master
          CONTAINER_NAME=paro-master
          docker rm -f $CONTAINER_NAME || true
          docker run -d --rm --name $CONTAINER_NAME \
            -p 3030:3000 \
            -e NODE_ENV=production \
            $IMAGE_NAME:latest \
            sh -c "next start -H 0.0.0.0 -p 3000"
          sleep 10
          curl -I http://localhost:3030 || echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø"
          docker logs $CONTAINER_NAME

      - name: ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI/CD: ${{ job.status }} –¥–ª—è paroMaster"
          body: |
            –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞: ${{ job.status }}
            –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
          to: "ivan.roschin@86gmail.com"
          from: "CI/CD Bot <${{ secrets.SMTP_EMAIL }}>"

      - name: üì≤ Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‚úÖ CI/CD –∑–∞–≤–µ—Ä—à–µ–Ω!
            üì¶ –û–±—Ä–∞–∑: ${{ github.sha }}
            üîó –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}